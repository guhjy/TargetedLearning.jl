<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://targetedlearningjl.readthedocs.org/user-guide/ctmle/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

        <title>(C)TMLE - TargetedLearning.jl</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/prettify-1.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">TargetedLearning.jl</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../julia">Julia</a>
                        </li>
                    
                        <li >
                            <a href="../estimation">The estimation problem</a>
                        </li>
                    
                        <li class="active">
                            <a href=".">(C)TMLE</a>
                        </li>
                    
                        <li >
                            <a href="../influencecurves">Automatic influence curves</a>
                        </li>
                    
                        <li >
                            <a href="../lalonde_example">Lalonde Example</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">API <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../api/common">Common</a>
                        </li>
                    
                        <li >
                            <a href="../../api/lreg">LReg</a>
                        </li>
                    
                        <li >
                            <a href="../../api/parameters">Parameters</a>
                        </li>
                    
                        <li >
                            <a href="../../api/qmodels">Qmodels</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../about/license">License</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li >
                    <a rel="next" href="../estimation">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../influencecurves">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/lendle/TargetedLearning.jl/">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#notation">Notation</a></li>
        
    
        <li class="main "><a href="#tmle">TMLE</a></li>
        
            <li><a href="#fluctuating-barq_n">Fluctuating $\bar{Q}_n$</a></li>
        
            <li><a href="#example-implementation">Example implementation</a></li>
        
            <li><a href="#example-using-targetedlearningjl">Example using TargetedLearning.jl</a></li>
        
    
        <li class="main "><a href="#ctmle">CTMLE</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
              processEnvironments: true
             }
  );
</script>

<h1 id="notation">Notation</h1>
<ul>
<li>$O=(W, A, Y)$: Observed data structure<ul>
<li>$W$: real valued vector of baseline covariates</li>
<li>$A$: binary indicator of treatment (or missingness)</li>
<li>$Y$: scalar outcome, binary or bounded by $0$ and $1$.</li>
</ul>
</li>
<li>$O_i = (W_i, A_i, Y_i)$: $i$th observation for $i = 1, \ldots, n$.</li>
<li>$\mathcal{M}$: statistical model</li>
<li>$P\in \mathcal{M}$: a distribution of observed data $O$</li>
<li>$\Psi$: A statistical parameter mapping from $\mathcal{M}$ to $\mathbb{R}^k$.</li>
<li>$\psi$: $\Psi(P)$ for some $P$</li>
<li>$E_P$: expectation w.r.t. distribution $P$.</li>
<li>$\bar{Q}(a, w)$: $E_P(Y\mid A=a, W=w)$ for some $P$</li>
<li>$Q_W(w)$: $P(W=w)$, the marginal distribution of $W$.</li>
<li>$Q$: $(\bar{Q}, Q_W)$</li>
<li>$g(a \mid w)$ : $P(A=a\mid W=w)$</li>
<li>Subscript $0$ denotes some quantity for the true distribution, <em>e.g.</em> $\bar{Q}_0$ is $\bar{Q}$ where the expectation is taken w.r.t. the trued istribution $P_0$.</li>
<li>Subscript $n$ denotes an estimate based on $n$ observations, <em>e.g.</em> $g_n$ is an estimate of $g_0$.</li>
</ul>
<h1 id="tmle">TMLE</h1>
<p>TMLE is a general framework for constructing regular, asymptotically linear plug-in estimators. Details about how to use the TMLE framework to construct an estimator can be found in the <a href="https://www.springer.com/statistics/statistical+theory+and+methods/book/978-1-4419-9781-4">Targeted Learning</a> book by van der Laan and Rose, or <a href="http://scholar.google.com/scholar?q=targeted+estimation+tmle">articles</a> on TMLE.</p>
<p>Here we'll walk through an example of how to actually implement a TMLE for the average treatment effect (ATE) and skip over the details of the derivation.</p>
<p>Using <a href="../estimation#counterfactuals-and-causal-parameters">counterfactuals</a>, we define the ATE as $E_0(Y_1 - Y_0)$. Under causal assumptions, we can write this causal parameter as a parameter of the distribution of the observed data:
\begin{align}
\psi_0 = \Psi(P_0) =&amp; E_0(E_0(Y\mid A = 1, W) - E_0(Y\mid A=0, W)) \\
=&amp; E_{Q_{W0}}(\bar{Q}_0(1, W) - \bar{Q}_0(0, W)).
\end{align}
The parameter is computed by first taking the difference $\bar{Q}_0(1, W) - \bar{Q}_0(0, W)$, then averaging over $W$, so $\Psi$ only depends on $P$ through $Q=(\bar{Q}, Q_W)$. Recognizing the abuse of notation, we sometimes write $\Psi(\bar{Q}, Q_W)$. $g_0(a \mid w)$, sometimes called the propensity score, is a nuisance parameter.</p>
<p>A <strong>plug-in</strong> estimator is one that first estimates (relevant parts of) the distribution $P_0$ and then plugs it in to the parameter mapping. In our case, that's $\bar{Q}_0$ and $Q _ {W0}$.
A <strong>TMLE</strong> is a plug in estimator constructed by first finding an initial estimate of $Q_0$, and then updating those estimates using estimates of nuisance parameters ($g _ 0$ here), then computing a plug-in estimate based on the updated estimate of $Q$.
The update is done by fluctuating the initial estimator in such a way that the final plug in estimator is locally efficient and doubly robust.
It turns out in this example, that only the initial estimator of $\bar Q _ 0$ (and not $Q _ {Wn})$ requires a fluctuation.</p>
<p>$\bar{Q} _ 0$ is the conditional mean of $Y$, and can be estimated with regression techniques, <em>e.g.</em> logistic regression or something more flexible.  $Q _ {W0}$ is just a marginal distribution, and the easiest way to estimate that is with empirical distribution, so we'll use that for for $Q _ {Wn}$.
The fluctuation relies on an estimate of $g_0$, which is another conditional mean.</p>
<!---

Given estimates $\bar{Q} _ n$ and $Q _ {Wn}$ a simple plug in estimator for $\psi_0$ is be computed as
$$
\Psi(\bar{Q}_n, Q _ {Wn}) = \frac 1n \sum _ {i=1}^n (\bar{Q}_n(1, W_i) - \bar{Q}_n(0, W_i)).
$$

In general, an estimation method may not always result in an estimate that falls in the parameter space, particularly in small samples, even if that method is consistent or even efficient.
Plug-in estimators are one way to guarantee that estimates are always in the parameter space. For example, we know that the ATE must be between $-1$ and $1$, because $Y \in \[0, 1\]$. The plug-in estimator $\Psi(\bar{Q}_n, Q _ {Wn})$ will always be in $\[0, 1\]$, provided $\bar{Q}_n(a, w)$ is yields estimates in $\[0, 1\]$.

Plug-in estimators, however, are not efficient in general. TMLE constructs an efficient plug-in estimator by taking an initial estimate of $Q$, and updates it to $Q_n^*$ in such a way that the so-called efficient influence curve (EIC) equation is solved. For this particular example, only $\bar{Q}_n$ needs to be updated, and not $Q _ {Wn}$.  This update is also called a fluctuation.
 -->

<h2 id="fluctuating-barq_n">Fluctuating $\bar{Q}_n$</h2>
<p>Fluctuating the initial estimate $\bar{Q} _ n$ amounts to regressing $Y$ on a particular covariate using $\bar{Q} _ n$ as an offset.
In particular, we use the model
<!-- We have a choice of two fluctuation procedures: an *unweighted fluctuation* or a *weighted fluctuation*.
To describe them, we first we define a parametric submodel through the initial $\bar{Q}_n$, $\\{\bar{Q}_n(\epsilon) : \epsilon \in \mathbb{R} \\}$ using an estimate of $g_0$ such that $\bar{Q}_n(\epsilon=0) = \bar{Q}_n$. For the ATE, we will use
 -->
 $$
\mbox{logit} \bar{Q}_n(\epsilon)(a, w) = \mbox{logit} \bar{Q}_n(a, w) + h(a, w) \epsilon
$$
where $\mbox{logit}(x) = \log(x)/\log(1-x)$ and $h$ is a known function.
We also define a loss function for $\bar{Q}_n(\epsilon)$:
$$
\ell(\bar{Q}_n(\epsilon))(O) = - b(A, W) [Y \log(\bar{Q}_n(\epsilon)(A, W)) - (1-Y) \log (1-\bar{Q}_n(\epsilon)(A, W))],
$$
where $b$ is a known function.</p>
<p>If $Y$ is binary, you might recognize this as a logistic regression model for the conditional mean of $Y$ on the covariate $h(A,W)$ with $\mbox{logit} \bar{Q}_n(A, W)$ as a fixed offset and weights $b(A,W)$.
When $Y$ is not binary but bounded between $0$ and $1$, this is still a valid loss function for the conditional mean of $Y$.</p>
<p>In TargetedLearning.jl, there are two types of fluctuations supported, <em>unweighted</em> and <em>weighted</em>, which define the covariate and weight functions
$h$ and $b$.</p>
<ul>
<li><em>Unweighted fluctuation</em>:
\begin{gather}
h(a,w) = \frac{2a-1}{g_n(a\mid w)},  &amp; &amp;
b(a,w) = 1
\end{gather}</li>
<li><em>Weighted fluctuation</em>:
\begin{gather}
h(a,w) = 2a-1, &amp; &amp;
b(a,w) = \frac{1}{g_n(a\mid w)}
\end{gather}
<!--
Both are chosen such that
$$
h(a,w)b(a,w) = \frac{2a-1}{g_n(a\mid w)}.
This means that the score equation for $\epsilon$ in our quasi-logistic regression model
$$
\frac 1n \sum _ {i=1}^n \frac{2A-1}{g_n(A\mid W)} (Y - \bar{Q}_n(A,W)(\epsilon))
$$
is solved at $\epsilon_n$.
$$ --></li>
</ul>
<p>Once this choice is made, we compute an estimate of $\epsilon$ by minimizing the empirical mean of $\ell$:
$$
\epsilon_n = \arg\min _ {\epsilon} \sum _ {i =1} ^n \ell(\bar{Q}_n(\epsilon))(O_i).
$$
This amounts to fitting a (quasi-)logistic regression model with an offset and possibly with a weight.</p>
<p>Finally we set $\bar{Q}_ n ^* = \bar{Q}_n(\epsilon_n)$ and compute the final estimate of $\psi_0$ as $\Psi(\bar{Q} _ n ^*, Q _ {Qn})$:
$$
\Psi(\bar{Q} _ n^*, Q _ {Wn}) = \frac 1n \sum _ {i=1}^n (\bar{Q}_n^*(1, W_i) - \bar{Q}_n^*(0, W_i)).
$$</p>
<p>This final TMLE is a plug-in estimator by definition, and it is also doubly robust and locally efficient, meaning that if either the initial $\bar{Q}_n$ or $g_n$ estimate $\bar{Q}_0$ or $g_0$ consistently respectively, then $\Psi(Q_n^*)$ is consistent, and if both $\bar{Q}_0$ and $g_0$ are consistent, then $\Psi(Q_n^*)$ is efficient.</p>
<h2 id="example-implementation">Example implementation</h2>
<p>The math makes things a lot more complicated than they really are. Here's a simple implementation using the unweighted fluctuation:</p>
<pre><code class="julia"># input:
# logitQnA1, logitQnA0: vectors containing initial estimates \logit(\bar{Q}_n(a, W)) for a = 1 and 0, respectively
# gn1: a vector of containing estimates g_n(1 \mid W)
# A: binary treatment vector
# Y: outcome vector
# lreg is a simple wrapper function for logistic regression using the GLMNet.jl package

function simpletmle(logitQnA1, logitQnA0, gn1, A, Y)
    logitQnAA = ifelse(A.==1, logitQnA1, logitQnA0)
    gnA = ifelse(A .==1, gn1, 1 .- gn1)

    Qfit = lreg((2A .-1)./(gnA), Y, offset = logitQnAA)

    Qn⋆A1 = predict(Qfit, 1./gn1, offset = logitQnA1)
    Qn⋆A0 = predict(Qfit, -1./(1 .- gn1), offset = logitQnA0)

    return mean(Qn⋆A1 .- Qn⋆A0)
end
</code></pre>

<h2 id="example-using-targetedlearningjl">Example using TargetedLearning.jl</h2>
<p>Continuing the <a href="../julia#example">example</a> from the intro to Julia, we now demonstrate how to use TMLE to estimate the ATE from the Lalonde data set.</p>
<p><a href="http://nbviewer.ipython.org/url/lendle.github.io/TargetedLearning.jl/user-guide/lalonde_example.ipynb#TMLE-for-the-average-treatment-effect">The example can be found here.</a></p>
<h1 id="ctmle">CTMLE</h1>
</div>
        </div>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/prettify-1.0.min.js"></script>
        <script src="../../js/base.js"></script>
    </body>
</html>